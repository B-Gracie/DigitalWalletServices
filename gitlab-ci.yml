stages:
  - build
  - test
  - deploy

variables:
  DOCKER_REGISTRY_URL: 192.168.0.130:8443
  IMAGE_NAME: mywalletapp

services:
  - docker:dind

before_script:
  - mkdir -p $HOME/.docker
  - export DOCKER_TLS_CERTDIR=""

build:
  only:
    - master
  image: docker:latest
  script:
    - docker login -u Bookey -p Bookey_16 https://192.168.0.130:8443/
    - docker build -t $DOCKER_REGISTRY_URL/mywalletapp .
    - docker push $DOCKER_REGISTRY_URL/mywalletapp
  stage: build

test:
  stage: test
  services:
    - docker:dind
  image: mcr.microsoft.com/dotnet/sdk:6.0-focal
  script:
    - dotnet test --no-restore
  dependencies:
    - build

deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker pull $DOCKER_REGISTRY_URL/mywalletapp
    - docker run -d -p 80:80 $DOCKER_REGISTRY_URL/mywalletapp
  dependencies:
    - build

